<!DOCTYPE html>
<html>
  <head>
      <meta charset='utf-8' />
      <title>Bauprojekte und Brennpunkte in der Stadtregion S5</title>
      <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
      <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700' rel='stylesheet'>
      <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.js'></script>
      <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.css' rel='stylesheet' />
      <link href="s5map.css" rel="stylesheet">
  </head>
  
  <body>
    <div class='sidebar'>
      <div class='heading'>
        <h1>Projekt/Objekt</h1>
      </div>
    <div id='listings' class='listings'></div>
    </div>
    <div id='map' class='map'> </div>
    
  <script>
  // This will let you use the .remove() function later on
  if (!('remove' in Element.prototype)) {
      Element.prototype.remove = function() {
          if (this.parentNode) {
              this.parentNode.removeChild(this);
          }
      };
  }

  mapboxgl.accessToken = 'pk.eyJ1IjoiZXhhbXBsZXMiLCJhIjoiY2lqbmpqazdlMDBsdnRva284cWd3bm11byJ9.V6Hg2oYJwMAxeoR9GEzkAA';

  // This adds the map
  var map = new mapboxgl.Map({
      // container id specified in the HTML
      container: 'map',
      // style URL
      style: 'mapbox://styles/mapbox/light-v9',
      // initial position in [long, lat] format
      center: [8.73, 47.3],
      // initial zoom
      zoom: 11
  });
  /*
  https://docs.google.com/document/d/1T8s82w7HAidq8l49oHmVLcn4VYNrnbd5aIoGD4ukBps/edit?usp=sharing

  var stores =
  */

  // This adds the data to the map
  var stores = $.ajax({
      //   url: "https://docs.google.com/document/d/1T8s82w7HAidq8l49oHmVLcn4VYNrnbd5aIoGD4ukBps/edit?usp=sharing"
      url: 'beispielobjektsammlung.geojson'

  }).done(function(data) {
      data = eval('(' + data + ')');
      map.on('load', function(e) {
          // Add a GeoJSON source containing place coordinates and information.
          map.addSource('places', {
              'type': 'geojson',
              'data': data
          });

          data.features.forEach(function(marker, i) {
              // Create an img element for the marker
              var el = document.createElement('div');
              el.id = 'marker-' + i;
              el.className = 'marker';
              el.style.left = '-28px';
              el.style.top = '-46px';
              // Add markers to the map at all points
              new mapboxgl.Marker(el)
                  .setLngLat(marker.geometry.coordinates)
                  .addTo(map);

              el.addEventListener('click', function(e) {
          // 1. Fly to the point
          flyToStore(marker);

          // 2. Close all other popups and display popup for clicked store
          createPopUp(marker);

          // 3. Highlight listing in sidebar (and remove highlight for all other listings)
          var activeItem = document.getElementsByClassName('active');

          e.stopPropagation();
          if (activeItem[0]) {
              activeItem[0].classList.remove('active');
          }

          var listing = document.getElementById('listing-' + i);
          listing.classList.add('active');

      });
              buildLocationList(data);
          });

          // This is where your '.addLayer()' used to be
          // Initialize the list

      });
  });

  // This is where your interactions with the symbol layer used to be
  // Now you have interactions with DOM markers instead

  function flyToStore(currentFeature) {
      map.flyTo({
          center: currentFeature.geometry.coordinates,
          zoom: 13
      });
  }

  function createPopUp(currentFeature) {
      var popUps = document.getElementsByClassName('mapboxgl-popup');
      if (popUps[0]) popUps[0].remove();

      var popup = new mapboxgl.Popup({closeOnClick: false})
            .setLngLat(currentFeature.geometry.coordinates)
            .setHTML('<h3>' + currentFeature.properties.Obj_Name + ', ' + currentFeature.properties.Obj_Gem + '</h3>' +
              '<h4>' + currentFeature.properties.Obj_Funktion + '</h4>' +
              '<h4>' + currentFeature.properties.Obj_Qualitaet + '</h4>' )
            .addTo(map);
  }

  function buildLocationList(data) {
      for (i = 0; i < data.features.length; i++) {
          var currentFeature = data.features[i];
          var prop = currentFeature.properties;

          var listings = document.getElementById('listings');
          var listing = listings.appendChild(document.createElement('div'));
          listing.className = 'item';
          listing.id = 'listing-' + i;

          var link = listing.appendChild(document.createElement('a'));
          link.href = '#';
          link.className = 'title';
          link.dataPosition = i;
          link.innerHTML = prop.Obj_Name;

          var details = listing.appendChild(document.createElement('div'));
          details.innerHTML = prop.Kommentar;
          if (prop.Obj_Gem) {
              details.innerHTML += ' &middot; ' + prop.Obj_Gem;
          }

          link.addEventListener('click', function(e) {
              // Update the currentFeature to the store associated with the clicked link
              var clickedListing = data.features[this.dataPosition];

              // 1. Fly to the point
              flyToStore(clickedListing);

              // 2. Close all other popups and display popup for clicked store
              createPopUp(clickedListing);

              // 3. Highlight listing in sidebar (and remove highlight for all other listings)
              var activeItem = document.getElementsByClassName('active');

              if (activeItem[0]) {
                  activeItem[0].classList.remove('active');
              }
              this.parentNode.classList.add('active');

          });
      }
  }

    </script>
  </body>
</html>

